<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.douzone.dataservice.mapper.UnsuitableSampleMapper">
    <select id="findSampleByBarcode" resultType="Map" parameterType="Long">
        SELECT c.barcode,
            i.status_name AS statusName,
            DATE_FORMAT(c.barcode_dt,'%Y-%m-%d') AS barcodeDt,
            DATE_FORMAT(c.collecting_dt,'%Y-%m-%d') AS collectingDt,
            v.vessel_code AS vesselCode,
                (SELECT u.user_name
                FROM collecting AS c LEFT JOIN user AS u ON c.barcode_printer_id = u.user_id
                WHERE c.barcode = #{barcode} ) AS barcodePrinterId,
                (SELECT u.user_name
                FROM collecting AS c LEFT JOIN user AS u ON c.collector_id = u.user_id
                WHERE c.barcode = #{barcode} ) AS collectorId,
            c.prescribe_code AS prescribeCode,
            c.cancel_barcode_dt AS cancelBarcodeDt,
            c.cancel_collecting_dt AS cancelCollectingDt
        FROM collecting AS c LEFT JOIN user AS u ON c.barcode_printer_id = u.user_id  AND c.collector_id = u.user_id
        LEFT JOIN prescribe AS p ON c.prescribe_code = p.prescribe_code
        LEFT JOIN order_slip AS o ON p.order_code = o.order_code
        LEFT JOIN inspection_status AS i ON p.status_code = i.status_code
        LEFT JOIN vessel AS v ON o.vessel_code = v.vessel_code
        WHERE c.barcode = #{barcode};
    </select>

    <select id="findPrescribeByBarcode" resultType="Map" parameterType="Long">
        SELECT p.prescribe_Code AS prescribeCode,
            u.user_name AS userName,
            o.order_name AS orderName,
            p.doctor_id AS doctorId,
            v.visit_status AS visitStatus,
            ii.status_name AS statusName,
            p.prescribe_contents AS prescribeContents,
            p.prescribe_dt AS prescribeDt
        FROM collecting AS c LEFT JOIN prescribe AS p ON c.prescribe_code = p.prescribe_code
        LEFT JOIN user AS u ON p.doctor_id = u.user_id
        LEFT JOIN visit AS v ON p.visit_code = v.visit_code
        LEFT JOIN order_slip AS o ON o.order_code = p.order_code
        LEFT JOIN inspection_status AS ii ON p.status_code = ii.status_code
        WHERE c.barcode =  #{barcode};
    </select>

    <select id="findUsersByUsername" resultType="Map" parameterType="String">
        SELECT user_id AS userId,
            user_name AS userName,
            user_email AS userEmail,
            authority
        FROM user
        WHERE authority != "검사자"  and user_name = #{userName};
    </select>

    <select id="findAllUnsuitableReason" resultType="com.douzone.dataservice.domain.UnsuitableReasonDTO">
        SELECT unsuitable_reason_code,
            unsuitable_reason_name,
            unsuitable_status_code
        FROM unsuitable_reason;
    </select>

    <select id="findUnsuitableSample" resultType="com.douzone.dataservice.domain.UnsuitableSampleDTO" parameterType="Long">
        SELECT unsuitable_reason_code,
            barcode,
            notified_user_id,
            notificator_id,
            unsuitable_reason_text
        FROM data.unsuitable_status_management
        WHERE barcode = #{barcode};
    </select>
</mapper>